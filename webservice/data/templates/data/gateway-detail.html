{% extends "data/template.html" %}

{% load staticfiles %}

{% block title %}Sensors{% endblock %}

{% block bread_1 %}<li><a href="/rest/companies/">Companies</a></li>{% endblock %}
{% block bread_active %}<li class="active">Gateway {{ gateway_id }}</li>{% endblock %}

{% block content %}
<h1>Gateway {{ gateway_id }}</h1>

<style>
    #measurements {
        max-height:300px;
        overflow-y:auto;
        overflow-x:scroll;
    }
</style>

<div class="row">
    <div class="col-md-6">
        <div class="tabbable">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#type-tab1" data-toggle="tab">Capacitance</a></li>
                <li><a href="#type-tab2" data-toggle="tab">Temperature</a></li>
                <li><a href="#type-tab3" data-toggle="tab">Humidity</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="type-tab1">
                    <p>Capacitance measurements</p>
                    <!-- Measurements Table -->
                    <div class="row" id="measurements"></div>
                </div>
                <div class="tab-pane" id="type-tab2">
                    <p>Temperature measurements</p>
                </div>
                <div class="tab-pane" id="type-tab3">
                    <p>Humidity measurements</p>
                </div>
            </div>
        </div>

       <!-- <div class="table-responsive">
            <table class="table-striped">
                <thead>
                    <tr>
                        {% for sensor in sensors %}
                            <th>Sensor {{ sensor.sensor_id }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        &lt;!&ndash; Fetch measurement data via AJAX request.&ndash;&gt;
                    {% for sensor in sensors %}
                            <td>1.64578</td>
                    {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>-->
    </div>

    <div class="col-md-6">
        <!-- Meta data -->
        <div class="panel panel-default">
            <div class="panel-body">
                API Key: {{ api_key }}
            </div>
        </div>

        <div>
            <!-- Map -->
             <!--<img src="{% static 'data/images/u1.png' %}" class="img-responsive" >-->
            <div id="googleMap" style="width:500px;height:380px;"></div>
        </div>

        <div>
            <!-- Config -->
            <h2>Configuration</h2>
            <!--<button>Edit</button>-->
            <div class="table-responsive">
                <table class="table-striped">
                    <thead>
                        <tr>
                            <th>Attribute</th>
                            <th>Value</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for conf in config %}
                        <tr>
                            <td>{{ conf.attribute }}</td>
                            <td>{{ conf.value }}</td>
                            <td><p data-placement="top" data-toggle="tooltip" title="Edit">
                                <a class="btn btn-primary btn-xs" data-title="Edit" href="{% url 'gatewayconfiguration-edit' gateway_id conf.id %}"><span class="glyphicon glyphicon-pencil"></span></a></p></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p id="demo"></p>

            <!--<div class="modal fade" id="editGatewayConf" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                            <h4 class="modal-title custom_align" id="Heading">Edit gateway configuration</h4>
                        </div>
                        <form action="/rest/gateways/" role="form" method="POST">
                            {% csrf_token %}
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="attribute">Attribute:</label>
                                    <input name="attribute" id="attribute" class="form-control" type="text" placeholder="Test">
                                </div>
                                <div class="form-group">
                                    <label for="value">Value:</label>
                                    <input name="value" id="value" class="form-control" type="text" placeholder="1">
                                </div>
                            </div>
                            <div class="modal-footer ">
                                <div class="form-group">
                                    &lt;!&ndash;<input id="updateRow2" class="form-control " type="text" placeholder="1">&ndash;&gt;
                                    <button type="submit" class="btn btn-warning btn-lg" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> Update</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    &lt;!&ndash; /.modal-content &ndash;&gt;
                </div>
                &lt;!&ndash; /.modal-dialog &ndash;&gt;
            </div>-->

        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <h2>Sensors</h2>
        <a href="">Edit Common Configuration</a>
        <!-- Sets Config Options for all sensors in this gateway in one go.-->
    </div>
</div>

<!-- Tab for each sensor -->
<div class="tabbable tabs-left">
    <div class="row">
        <div class="col-md-2">
            <ul class="nav nav-pills nav-stacked">
                {% for sensor in sensors %}
                    <li><a href="#sensor-tab{{ sensor.sensor_id }}" data-toggle="tab">Sensor {{ sensor.sensor_id }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-10">
            <div class="row">
                <div class="tab-content">
                     <!--<div class="tabbable">-->
                         <!--<ul class="nav nav-tabs">-->
                             <!--<li class="active"><a href="#type-tab4" data-toggle="tab">Capacitance</a></li>-->
                             <!--<li><a href="#type-tab5" data-toggle="tab">Temperature</a></li>-->
                             <!--<li><a href="#type-tab6" data-toggle="tab">Humidity</a></li>-->
                         <!--</ul>-->
                         <!--<div class="tab-content">-->
                             <!--<div class="tab-pane active" id="type-tab4">-->
                                 <!--<p>Capacitance measurements</p>-->
                             <!--</div>-->
                             <!--<div class="tab-pane" id="type-tab5">-->
                                 <!--<p>Temperature measurements</p>-->
                             <!--</div>-->
                             <!--<div class="tab-pane" id="type-tab6">-->
                                 <!--<p>Humidity measurements</p>-->
                             <!--</div>-->
                         <!--</div>-->
                    <!--</div>-->
                    {% for sensor in sensors %}
                        <div class="tab-pane" id="sensor-tab{{ sensor.sensor_id }}">
                            <div class="row">
                                <h2>Measurements</h2>
                                <div class="tabbable">
                                    <ul class="nav nav-tabs">
                                        <li class="active"><a href="#type-tab1-{{ sensor.sensor_id }}" data-toggle="tab">Capacitance</a></li>
                                        <li><a href="#type-tab2-{{ sensor.sensor_id }}" data-toggle="tab">Temperature</a></li>
                                        <li><a href="#type-tab3-{{ sensor.sensor_id }}" data-toggle="tab">Humidity</a></li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane active" id="type-tab1-{{ sensor.sensor_id }}">
                                            <!--<p>Capacitance measurements</p>-->
                                            <!--<h3>Here will come the measurements for Sensor {{ sensor.sensor_id }}</h3>-->
                                            <!--<script type="text/javascript">-->
                                                <!--var url = '/rest/gateways/{{ gateway_id }}/sensors/{{ sensor.sensor_id }}/measurements.json?type=0&start=2015-01-01&end=2020-01-01'-->
                                                <!--var chart_id = 'measurement_chart-{{ sensor.sensor_id }}';-->
                                            <!--</script>-->
                                            <!--<script type="text/javascript" src="{% static 'data/measurement_chart.js' %}"></script>-->
                                            <div id="measurement_chart-{{ sensor.sensor_id }}" class="chart"></div>
                                        </div>
                                        <div class="tab-pane" id="type-tab2-{{ sensor.sensor_id }}">
                                            <p>Temperature measurements</p>
                                        </div>
                                        <div class="tab-pane" id="type-tab3-{{ sensor.sensor_id }}">
                                            <p>Humidity measurements</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                            <!-- Detailed view of selected sensor -->
                                <h2>Configuration</h2>
                                <button>Edit</button>
                                <div class="table-responsive">
                                    <table class="table-striped">
                                        <thead>
                                            <tr>
                                                <th>Attribute</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for conf in sensor.config %}
                                            <tr>
                                                <td>{{ conf.attribute }}</td>
                                                <td>{{ conf.value }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <h2>Location</h2>
                                <div class="col-md-12">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h4>Longitude</h4>
                                        </div>
                                        <div class="col-md-3">
                                            <p>04</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p>04</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p>04</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <h4>Latitude</h4>
                                        </div>
                                        <div class="col-md-3">
                                            <p>51</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p>0</p>
                                        </div>
                                        <div class="col-md-3">
                                            <p>13</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<!--<script>
    function updateFunc() {
        document.getElementById("demo").innerHTML = "Hello world";
    }
</script>-->
{% block scripts %}
<script>
    base_url = "/rest/gateways/{{ gateway_id }}/sensors/"
    sensors = [
    {% for sensor in sensors %}
        "{{ sensor.sensor_id }}",
    {% endfor %}
    ];

    sensors.forEach(function(s) {
        console.log(s);
        $.getJSON(base_url + s + "/measurements.json?type=0&start=2016-03-04", function(data) {
            sensor_id = 1;
            var items = [];
            $.each( data.measurements, function(index, value) {
                console.log(value[1])
                items.push( "<li>" + value[1] + "</li>" );
            });

            $("#measurements").append(
                        $("<div/>", { class : "col-md-2"}).append(
                                                                $("<p/>", {
                                                                    text : "Sensor " + s
                                                                    }))
                                                          .append(
                                                                $("<ul/>").append(
                                                                        items.join("")
                                                                )
                                                          )
            );
        });
    });
</script>

<script>
function initialize() {
  var mapProp = {
    center:new google.maps.LatLng(50.8748576, 4.7055737),
    zoom:18,
    mapTypeId:google.maps.MapTypeId.ROADMAP
  };
  var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>

<script>
function initialize() {
  var mapProp = {
    center:new google.maps.LatLng(50.8748576, 4.7055737),
    zoom:18,
    mapTypeId:google.maps.MapTypeId.ROADMAP
  };
  {% for sensor in sensors %}
    var map{{ sensor.sensor_id }}=new google.maps.Map(document.getElementById("googleMap-{{ sensor.sensor_id }}"),mapProp);
  {% endfor %}
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>

<script src="{% static 'data/measurement_chart.js' %}"></script>

<script>
$(document).ready(function(){
    $(".nav-pills a").click(function(){
        $(this).tab('show');
    });
    $('.nav-pills a').on('shown.bs.tab', function(event){
        var pillName = $(event.target).text(); // Sensor x
        var id = pillName.slice(-1); // x
        console.log(pillName);
        console.log(id);
        var url = '/rest/gateways/{{ gateway_id }}/sensors/' + id + '/measurements.json?type=0&start=2015-01-01&end=2020-01-01';
        var chart_id = 'measurement_chart-' + id;
        console.log(url);
        console.log(chart_id);

        var margin = {
                top: 20,
                right: 50,
                bottom: 30,
                left: 50
            },
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S").parse,
            bisectDate = d3.bisector(function(d) {
                return d.timestamp;
            }).left,
            formatValue = d3.format(",.2f"),
            formatUnit = function(d) {
                return formatValue(d) + "pF";
            };

        var x = d3.time.scale()
            .range([0, width])
            .nice();

        var y = d3.scale.linear()
            .range([height, 0])
            .nice();

        var line = d3.svg.line()
            .x(function(d) {
                return x(d.timestamp);
            })
            .y(function(d) {
                return y(d.value);
            });

        d3.json(url, function(error, incoming_data) {
            if (error) throw error;

            var data = incoming_data.measurements;

            data.forEach(function(d) {
                d.timestamp = parseDate(d[0]);
                d.value = +d[1];
            });

            data.sort(function(a, b) {
                return a.timestamp - b.timestamp;
            });

            drawGraph(data, chart_id);

        });
    });
});
</script>
{% endblock %}