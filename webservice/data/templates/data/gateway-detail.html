{% extends "data/template.html" %}

{% load staticfiles %}

{% block title %}Sensors{% endblock %}

{% block bread_1 %}<li><a href="{% url 'gateway-list' %}">Gateways</a></li>{% endblock %}
{% block bread_active %}<li class="active">Gateway {{ gateway_id }}</li>{% endblock %}

{% block content %}
<h1>Gateway {{ gateway_id }}</h1>

<style>
    #measurements {
        max-height:600px;
        overflow-y:auto;
        overflow-x:scroll;
    }

    .measurements {
        max-height:600px;
        overflow-y:auto;
        overflow-x:scroll;
    }
</style>

<div class="row">
    <div class="col-md-6">
        <div class="tabbable">
            <ul class="nav nav-tabs" id="measurementDataTabs">
                {% for t in measurement_types %}
                    <li>
                        <a href="#type-tab{{ t.measurementTypeID }}" data-toggle="tab" data-measurement-type="{{ t.measurementTypeID }}">{{ t.name }}</a>
                    </li>
                {% endfor %}
                <!--<li class="active">-->
                    <!--<a href="#type-tab1" data-toggle="tab" data-measurement-type="1">Capacitance</a>-->
                <!--</li>-->
                <!--<li>-->
                    <!--<a href="#type-tab2" data-toggle="tab" data-measurement-type="2">Temperature</a>-->
                <!--</li>-->
                <!--<li>-->
                    <!--<a href="#type-tab3" data-toggle="tab" data-measurement-type="3">Humidity</a>-->
                <!--</li>-->
            </ul>
            <div class="tab-content">
                {% for t in measurement_types %}
                    <div class="tab-pane" id="type-tab{{ t.measurementTypeID }}">
                        <div class="row measurements" id="measurements-type-{{ t.measurementTypeID }}">
                            <button onclick="loadPrevMeasurements({{ t.measurementTypeID }});" data-measurement-type="{{ t.measurementTypeID }}">Back</button>
                            <button onclick="loadNextMeasurements({{ t.measurementTypeID }});" data-measurement-type="{{ t.measurementTypeID }}">Forward</button>
                            <table class="table table-striped">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <!-- Meta data -->
        <div class="panel panel-default">
            <div class="panel-body">
                API Key: {{ api_key }}
            </div>
        </div>

        <div>
            <!-- Map -->
             <!--<img src="{% static 'data/images/u1.png' %}" class="img-responsive" >-->
            <div id="googleMap" style="width:500px;height:380px;"></div>
        </div>

        <div>
            <!-- Config -->
            <h2>Configuration</h2>
            <!--<button>Edit</button>-->
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Attribute</th>
                            <th>Value</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for conf in config %}
                            {% if conf.deleted %}
                                <tr class="deleted">
                                    <td>{{ conf.attribute }}</td>
                                    <td>{{ conf.value }}</td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td>{{ conf.attribute }}</td>
                                    <td>{{ conf.value }}</td>
                                    <td>
                                        <a class="btn btn-primary btn-xs" data-toggle="tooltip" data-placement="top" title="Edit"
                                            href="{% url 'gatewayconfiguration-edit' gateway_id conf.id %}">
                                            <span class="glyphicon glyphicon-pencil"></span>
                                        </a>
                                    </td>
                                    <td>
                                        <form action="/rest/gateways/1/config/{{ conf.id }}.html" data-method="DELETE">
                                              <button class="btn btn-danger btn-xs" data-placement="top" data-toggle="tooltip" title="Delete">
                                                  <span class="glyphicon glyphicon-trash"></span>
                                              </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{% url 'gateway-new-config' gateway_id %}">Add Configuration</a>

            <!-- Delete Modal -->
            <div class="modal fade" id="deleteGConf" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                      <div class="modal-content">
                          <div class="modal-body">
                              <h4 class="text-center">Are you sure you want to delete this Gateway Configuration Instance?</h4>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                              <form class="button-form" action="/rest/gateways/1/config/18/" data-method="DELETE">
                                  <button class="btn btn-danger">Delete</button>
                              </form>
                          </div>
                      </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <h2>Sensors</h2>
        <a href="">Edit Common Configuration</a>
        <!-- Sets Config Options for all sensors in this gateway in one go.-->
    </div>
</div>

<!-- Tab for each sensor -->
<div class="tabbable tabs-left">
    <div class="row">
        <div class="col-md-2">
            <ul class="nav nav-pills nav-stacked">
                {% for sensor in sensors %}
                    <li><a href="#sensor-tab{{ sensor.sensor_id }}" data-toggle="tab">Sensor {{ sensor.sensor_id }}</a></li>
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-10">
            <div class="row">
                <div class="tab-content">
                    {% for sensor in sensors %}
                        <div class="tab-pane" id="sensor-tab{{ sensor.sensor_id }}">
                            <div class="row">
                                <h2>Measurements</h2>
                                <div class="tabbable">
                                    <ul class="nav nav-tabs" id="graphDataTabs">
                                        {% for t in measurement_types %}
                                            <li>
                                                <a href="#type-tab{{ t.measurementTypeID }}-{{ sensor.sensor_id }}" data-toggle="tab" data-measurement-type-name="{{ t.name }}" data-measurement-type="{{ t.measurementTypeID }}">{{ t.name }}</a>
                                            </li>
                                        {% endfor %}
                                        <!--<li class="active"><a href="#type-tab1-{{ sensor.sensor_id }}" data-toggle="tab">Capacitance</a></li>-->
                                        <!--<li><a href="#type-tab2-{{ sensor.sensor_id }}" data-toggle="tab">Temperature</a></li>-->
                                        <!--<li><a href="#type-tab3-{{ sensor.sensor_id }}" data-toggle="tab">Humidity</a></li>-->
                                    </ul>
                                    <div class="tab-content">
                                        {% for t in measurement_types %}
                                            <div class="tab-pane" id="type-tab{{ t.measurementTypeID }}-{{ sensor.sensor_id }}">
                                                <div class="chart" id="measurement_chart-{{ t.measurementTypeID }}-{{ sensor.sensor_id }}"></div>
                                            </div>
                                        {% endfor %}
                                        <!--<div class="tab-pane active" id="type-tab1-{{ sensor.sensor_id }}">-->
                                            <!--&lt;!&ndash;<p>Capacitance measurements</p>&ndash;&gt;-->
                                            <!--&lt;!&ndash;<h3>Here will come the measurements for Sensor {{ sensor.sensor_id }}</h3>&ndash;&gt;-->
                                            <!--&lt;!&ndash;<script type="text/javascript">&ndash;&gt;-->
                                                <!--&lt;!&ndash;var url = '/rest/gateways/{{ gateway_id }}/sensors/{{ sensor.sensor_id }}/measurements.json?type=0&start=2015-01-01&end=2020-01-01'&ndash;&gt;-->
                                                <!--&lt;!&ndash;var chart_id = 'measurement_chart-{{ sensor.sensor_id }}';&ndash;&gt;-->
                                            <!--&lt;!&ndash;</script>&ndash;&gt;-->
                                            <!--&lt;!&ndash;<script type="text/javascript" src="{% static 'data/measurement_chart.js' %}"></script>&ndash;&gt;-->
                                            <!--<div id="measurement_chart-{{ sensor.sensor_id }}" class="chart"></div>-->
                                        <!--</div>-->
                                        <!--<div class="tab-pane" id="type-tab2-{{ sensor.sensor_id }}">-->
                                            <!--<p>Temperature measurements</p>-->
                                        <!--</div>-->
                                        <!--<div class="tab-pane" id="type-tab3-{{ sensor.sensor_id }}">-->
                                            <!--<p>Humidity measurements</p>-->
                                        <!--</div>-->
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                            <!-- Detailed view of selected sensor -->
                                <h2>Configuration</h2>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Attribute</th>
                                                <th>Value</th>
                                                <th>Edit</th>
                                                <th>Delete</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for conf in sensor.config %}
                                                {% if conf.deleted %}

                                                    <tr class="deleted">
                                                        <td>{{ conf.attribute }}</td>
                                                        <td>{{ conf.value }}</td>
                                                    </tr>
                                                {% else %}
                                                    <tr>
                                                        <td>{{ conf.attribute }}</td>
                                                        <td>{{ conf.value }}</td>
                                                        <td><p data-placement="top" data-toggle="tooltip" title="Edit">
                                                            <a class="btn btn-primary btn-xs" data-title="Edit" href="{% url 'sensorconfiguration-edit' gateway_id sensor.sensor_id conf.id %}"><span class="glyphicon glyphicon-pencil"></span></a></p></td>
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                 <a href="{% url 'sensor-new-config' gateway_id sensor.sensor_id %}">Add Configuration</a>
                            </div>
                            <div class="row">
                                <h2>Location</h2>
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Longitude</th>
                                                <th>Latitude</th>
                                                <th>Edit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        <tr>
                                            <td>{{ sensor.position_long }}</td>
                                            <td>{{ sensor.position_lat }}</td>
                                            <td><p data-placement="top" data-toggle="tooltip" title="Edit">
                                                <a class="btn btn-primary btn-xs" data-title="Edit" href="{% url 'sensor-edit' gateway_id sensor.sensor_id %}"><span class="glyphicon glyphicon-pencil"></span></a></p></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<!--<script>
    function deleteFunc() {
        console.log(id);
        window.location.href = "{% url 'gatewayconfiguration-deactivate' gateway_id id %}";
    }
</script>-->
{% block scripts %}
<script src="{% static 'data/moment.js' %}"></script>

<script>
    base_url = "/rest/gateways/{{ gateway_id }}/measurements";

    var start = moment().subtract(20, 'days');
    var end = moment();
</script>
<script src="{% static 'data/gateway.js' %}"></script>

<script>
function initialize() {
  var mapProp = {
    center:new google.maps.LatLng(50.8748576, 4.7055737),
    zoom:18,
    mapTypeId:google.maps.MapTypeId.ROADMAP
  };
  var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>

<script src="{% static 'data/measurement_chart.js' %}"></script>

<script>
$(document).ready(function(){
    $(".nav-pills a").click(function(){
        $(this).tab('show');
    });
    $('.nav-pills a').on('shown.bs.tab', function(event){
        var pillName = $(event.target).text(); // Sensor x
        var id = pillName.slice(-1); // x
        console.log(pillName);
        console.log(id);

        function loadGraph(type, typeName) {
            var url = '/rest/gateways/{{ gateway_id }}/sensors/' + id + '/measurements.json?type=' + type + '&start=2015-01-01&end=2020-01-01';
            var chart_id = 'measurement_chart-' + type + '-' + id;
            console.log(url);
            console.log(chart_id);

            var margin = {
                    top: 20,
                    right: 50,
                    bottom: 30,
                    left: 50
                },
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S").parse,
                bisectDate = d3.bisector(function(d) {
                    return d.timestamp;
                }).left,
                formatValue = d3.format(",.2f"),
                formatUnit = function(d) {
                    return formatValue(d) + "pF";
                };

            var x = d3.time.scale()
                .range([0, width])
                .nice();

            var y = d3.scale.linear()
                .range([height, 0])
                .nice();

            var line = d3.svg.line()
                .x(function(d) {
                    return x(d.timestamp);
                })
                .y(function(d) {
                    return y(d.value);
                });

            d3.json(url, function(error, incoming_data) {
                if (error) throw error;

                var data = incoming_data.measurements;

                data.forEach(function(d) {
                    d.timestamp = parseDate(d[0]);
                    d.value = +d[1];
                });

                data.sort(function(a, b) {
                    return a.timestamp - b.timestamp;
                });

                drawGraph(data, chart_id, typeName);

            });
        }

        $('#graphDataTabs a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
           console.log(e.target.dataset.measurementType); // newly activated tab
           loadGraph(e.target.dataset.measurementType, e.target.dataset.measurementTypeName);
        })

    });
});
</script>
{% endblock %}